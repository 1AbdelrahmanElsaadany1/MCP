@{
    ViewData["Title"] = "AI Assistant";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-robot"></i> Student Management Assistant</h5>
                    <small>Powered by llama3</small>
                </div>

                <div class="card-body p-0">
                    <div id="chatBox" style="height: 450px; overflow-y: auto; padding: 1rem;">
                        <div class="text-center text-muted mt-5">
                            <i class="bi bi-chat-dots" style="font-size: 2rem;"></i>
                            <p class="mt-2">Ask me anything. Try: "Add student Ahmed, ahmed@test.com, department 1"</p>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <div class="input-group">
                        <input id="userInput" type="text" class="form-control"
                               placeholder="Type a message..." autocomplete="off" />
                        <button class="btn btn-primary" onclick="sendMessage()">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let history = [];

    document.getElementById("userInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendMessage();
    });

    async function sendMessage() {
        const input = document.getElementById("userInput");
        const message = input.value.trim();
        if (!message) return;

        appendMessage("You", message, "user");
        input.value = "";

        const thinking = appendMessage("Assistant", "Thinking...", "assistant");

        const response = await fetch("/Chat/Send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, history })
        });

        const data = await response.json();
        history = data.history;

        thinking.querySelector(".msg-text").textContent = data.reply;
    }

    function appendMessage(sender, text, type) {
        const chatBox = document.getElementById("chatBox");

        if (chatBox.querySelector(".text-center")) {
            chatBox.innerHTML = "";
        }

        const div = document.createElement("div");
        div.className = `d-flex mb-3 ${type === "user" ? "justify-content-end" : "justify-content-start"}`;
        div.innerHTML = `
            <div class="p-3 rounded-3 ${type === "user" ? "bg-primary text-white" : "bg-light"}" style="max-width: 75%;">
                <small class="fw-bold d-block mb-1">${sender}</small>
                <span class="msg-text">${text}</span>
            </div>`;

        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }
</script>